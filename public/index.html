<HTML>
<HEAD>
<TITLE>Load Graph</TITLE>
</HEAD>

<BODY onload="draw();">
	<h1>load.rrd</h1>
	<h3 id="cycle"></h2>
	<a href="/canvas">Canvas Stuff</a>
	<a href="/json">View raw JSON</a>
	<hr>
	<p>This graph is updated with this web server's hourly cpu load average. The value is pulled from this server's /proc/, and is updated every five minutes with the last five minutes' worth of data.</p>
	<img src="../graph/load_graph.png"><br>
	
	<br>
	<p>This is a graph rendered using HTML5's canvas object feature. A spooler script periodically pulls data from the RRD and exports it into a JSON file. A Javascript function in this web page then pulls that data from the file and uses it to draw this graph in a canvas element. It's currently a work in progress.</p>
	<canvas id="canvas" width="800" height="300"></canvas>
	<p>This is a chart generated using "Chart.js". You can find the source code for that jazz <a href="https://github.com/nnnick/Chart.js">here</a>.</p> <br>
	<canvas id="chart" width="800" height="400"></canvas>
	<p>JSON DATA:</p>
</BODY>

<script src="Chart.js/Chart.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<SCRIPT type="text/javascript">

function draw() {
	var canvas = document.getElementById('canvas');
	if (canvas.getContext) {
		var ctx = canvas.getContext('2d');
		
		// set up the axis
		
		ctx.fillStyle="#EEF1FC";
		ctx.fillRect(0,0,800,300);
		ctx.clearRect(65,30,705,235);
		ctx.strokeRect(0,0,800,300);

		ctx.font = "20px Arial";
		ctx.fillText("CPU Load Average",325,55);
		
		var path=new Path2D();
		ctx.beginPath();
		path.moveTo(65,25);
		path.lineTo(65,265);
		
		path.moveTo(65,265);
		path.lineTo(775,265);
		ctx.closePath(path);
		ctx.stroke(path);
		
		ctx.beginPath();
		ctx.lineWidth=0.5;
		path.moveTo(65,30);
		path.lineTo(770,30);

		path.moveTo(770,30);
		path.lineTo(770,265);
		ctx.strokeStyle="#000000";
		ctx.stroke(path);
		ctx.beginPath();
		ctx.strokeStyle="red";
	}

		$(document).ready(function(){
			$.getJSON("/json", function(data) {
				var items = [];

				$.each( data, function(key,val){
					items.push( "<li id='" + key + "->" + val + "</li>" );
				});
		
				$( "<ul/>", {
					"class": "my-new-list",
					html: items.join("")
				}).appendTo("body");
			});
		});
		$.getJSON("/json",function(data) {
			var points = [];

			$.each( data, function(key,val){
				points.push(val);
			});
			path.moveTo(65,265);
			for (i = 0; i < points.length; i++){
				points[i] = points[i] * 50;
				path.lineTo(65+i*11,points[i]+235);
				path.moveTo(65+i*11,points[i]+235);
			}	
			ctx.stroke(path);
		});

		$.getJSON("/json", function(data) {
			var points = [];
			var test_labels = [];
			test_labels.length = 30;
			for (i=0; i < test_labels.length; i++){
				test_labels[i] = i;
			}
			$.each( data, function(key,val){
				points.push(val);
			});
			var data = {
				labels: test_labels,
				datasets: [
					{
						label: "CPU Load Average",
						fillColor: "rgba(151,187,205,1)",
						strokeColor: "rgba(0,0,0,1)",
						pointColor: "rgba(0,0,0,1)",
						pointStrokeColor: "#000",
						pointHighlightFill: "#fff",
						pointHighlightStroke: "rgba(220,220,220,1)",
						data: points
					}
				]
			};
			var ctx = document.getElementById("chart").getContext("2d");
			var chart = new Chart(ctx).Line(data);
		});
}
</SCRIPT>
<SCRIPT>
	// random phrase
	var phrase_array = [];
	phrase_array[0] = "A thing that may or may not work";
	phrase_array[1] = "'I am so irritated.'";
	phrase_array[2] = "Will not break anything*";
	phrase_array[3] = "Exactly the same as prod";
	var rand_index = Math.floor(Math.random() * 4);
	document.getElementById("cycle").innerHTML = phrase_array[rand_index];
</SCRIPT>

</HTML>
